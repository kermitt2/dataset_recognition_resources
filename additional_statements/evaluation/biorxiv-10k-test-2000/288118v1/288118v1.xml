<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2d1 20170631//EN" "JATS-archivearticle1.dtd">
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="article" dtd-version="1.2d1" specific-use="production" xml:lang="en">
<front>
<journal-meta>
<journal-id journal-id-type="publisher-id">BIORXIV</journal-id>
<journal-title-group>
<journal-title>bioRxiv</journal-title>
<abbrev-journal-title abbrev-type="publisher">bioRxiv</abbrev-journal-title>
</journal-title-group>
<publisher>
<publisher-name>Cold Spring Harbor Laboratory</publisher-name>
</publisher>
</journal-meta>
<article-meta>
<article-id pub-id-type="doi">10.1101/288118</article-id>
<article-version>1.1</article-version>
<article-categories>
<subj-group subj-group-type="author-type">
<subject>Regular Article</subject>
</subj-group>
<subj-group subj-group-type="heading">
<subject>New Results</subject>
</subj-group>
<subj-group subj-group-type="hwp-journal-coll">
<subject>Bioinformatics</subject>
</subj-group>
</article-categories>
<title-group>
<article-title>AmpUMI: Design and analysis of unique molecular identifiers for deep amplicon sequencing</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3808-0811</contrib-id>
<name><surname>Clement</surname><given-names>Kendell</given-names></name>
<xref ref-type="aff" rid="a1">1</xref>
<xref ref-type="aff" rid="a2">2</xref>
<xref ref-type="aff" rid="a3">3</xref>
<xref ref-type="author-notes" rid="n1">&#x2020;</xref>
</contrib>
<contrib contrib-type="author">
<contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-3454-2946</contrib-id>
<name><surname>Farouni</surname><given-names>Rick</given-names></name>
<xref ref-type="aff" rid="a1">1</xref>
<xref ref-type="aff" rid="a2">2</xref>
<xref ref-type="aff" rid="a3">3</xref>
<xref ref-type="author-notes" rid="n1">&#x2020;</xref>
</contrib>
<contrib contrib-type="author">
<contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-5076-7945</contrib-id>
<name><surname>Bauer</surname><given-names>Daniel E.</given-names></name>
<xref ref-type="aff" rid="a2">2</xref>
<xref ref-type="aff" rid="a4">4</xref>
<xref ref-type="aff" rid="a5">5</xref>
<xref ref-type="aff" rid="a6">6</xref>
</contrib>
<contrib contrib-type="author" corresp="yes">
<contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-1109-3823</contrib-id>
<name><surname>Pinello</surname><given-names>Luca</given-names></name>
<xref ref-type="aff" rid="a1">1</xref>
<xref ref-type="aff" rid="a2">2</xref>
<xref ref-type="aff" rid="a3">3</xref>
<xref ref-type="corresp" rid="cor1">&#x002A;</xref>
</contrib>
<aff id="a1"><label>1</label><institution>Department of Molecular Pathology, Massachusetts General Hospital</institution>, Boston, MA</aff>
<aff id="a2"><label>2</label><institution>Harvard Medical School</institution>, Boston, MA</aff>
<aff id="a3"><label>3</label><institution>Broad Institute of MIT and Harvard</institution>, Cambridge, MA</aff>
<aff id="a4"><label>4</label><institution>Division of Hematology/Oncology, Boston Children&#x2019;s Hospital</institution>, Boston, MA</aff>
<aff id="a5"><label>5</label><institution>Department of Pediatric Oncology, Dana-Farber Cancer Institute</institution>, Boston, MA</aff>
<aff id="a6"><label>6</label><institution>Harvard Stem Cell Institute</institution>, Boston, MA</aff>
</contrib-group>
<author-notes>
<corresp id="cor1"><label>&#x002A;</label>To whom correspondence should be addressed, <email>lpinello@mgh.harvard.edu</email></corresp>
<fn id="n1"><label>&#x2020;</label><p>The authors wish it to be known that, in their opinion, the first two authors should be regarded as Joint First Authors.</p></fn>
</author-notes>
<pub-date pub-type="epub"><year>2018</year></pub-date>
<elocation-id>288118</elocation-id>
<history>
<date date-type="received">
<day>23</day>
<month>3</month>
<year>2018</year>
</date>
<date date-type="rev-recd">
<day>23</day>
<month>3</month>
<year>2018</year>
</date>
<date date-type="accepted">
<day>23</day>
<month>3</month>
<year>2018</year>
</date>
</history>
<permissions>
<copyright-statement>&#x00A9; 2018, Posted by Cold Spring Harbor Laboratory</copyright-statement>
<copyright-year>2018</copyright-year>
<license license-type="creative-commons" xlink:href="http://creativecommons.org/licenses/by/4.0/"><license-p>This pre-print is available under a Creative Commons License (Attribution 4.0 International), CC BY 4.0, as described at <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link></license-p></license>
</permissions>
<self-uri xlink:href="288118.pdf" content-type="pdf" xlink:role="full-text"/>
<abstract>
<title>Abstract</title>
<sec>
<title>Motivation</title>
<p>Unique molecular identifiers (UMIs) are added to DNA fragments before PCR amplification to discriminate between alleles arising from the same genomic locus and sequencing reads produced by PCR amplification. While computational methods have been developed to take into account UMI information in genome-wide and single-cell sequencing studies, they are not designed for modern amplicon based sequencing experiments, especially in cases of high allelic diversity. Importantly, no guidelines are provided for the design of optimal UMI length for amplicon-based sequencing experiments.</p>
</sec>
<sec>
<title>Results</title>
<p>Based on the total number of DNA fragments and the distribution of allele frequencies, we present a model for the determination of the minimum UMI length required to prevent UMI collisions and reduce allelic distortion. We also introduce a user-friendly software tool called AmpUMI to assist in the design and the analysis of UMI-based amplicon sequencing studies. AmpUMI provides quality control metrics on frequency and quality of UMIs, and trims and deduplicates amplicon sequences with user specified parameters for use in downstream analysis. AmpUMI is open-source and freely available at <ext-link ext-link-type="uri" xlink:href="http://github.com/pinellolab/AmpUMI">http://github.com/pinellolab/AmpUMI</ext-link>.</p>
</sec>
<sec>
<title>Contact</title>
<p><email>Ipinello@mgh.harvard.edu</email></p>
</sec>
</abstract>
<counts>
<page-count count="9"/>
</counts>
</article-meta>
</front>
<body>
<sec id="s1">
<label>1</label>
<title>Introduction</title>
<p>Next-generation sequencing technologies have enabled the rapid and cost-effective translation of biological DNA or RNA sequences to short sequencing reads that can be used to analyze and understand the genome. In most library preparation protocols, genomic material must be amplified using PCR to ensure successful sequencing. Exponential amplification is sequence dependent and differences in amplification rate may arise from variation in sequence composition (<xref ref-type="bibr" rid="c1">Aird<italic>et al</italic>., 2011</xref>). Duplicate sequencing reads resulting from PCR amplification may lead to biases in results or incorrect conclusions about the actual frequency of that read.</p>
<p>Many approaches have been developed for the deduplication of next-generation reads from across the genome. Some tools such as FastUniq (<xref ref-type="bibr" rid="c24">Xu <italic>et al</italic>., 2012</xref>) or Fulcrum (<xref ref-type="bibr" rid="c2">Burriesci <italic>et al</italic>., 2012</xref>) filter raw sequencing output in FASTQ format and remove any reads with the same sequence. Commonly used tools such as Picard MarkDuplicates (<xref ref-type="bibr" rid="c11">Li<italic>et al</italic>., 2009</xref>), samtools rmdup (<xref ref-type="bibr" rid="c10">Li, 2011</xref>), and SEAL (<xref ref-type="bibr" rid="c15">Pireddu <italic>et al</italic>., 2011</xref>) align the reads to the genome, and identify reads aligning to the same genomic position as duplicates. However, if two DNA fragments from different cells produce reads aligning to the same location, they will be incorrectly called as PCR duplicates, even though they originated from two different molecules. As sequencing depth increases, so does the chance of finding apparently duplicate reads that align to the same genomic location but are from different DNA fragments. In addition, nonuniform genomic fragment formation (e.g., short exons, restriction enzyme digestion, etc) can also increase the apparent rate of PCR duplicates if sequence identity and alignment coordinates are the only criteria for identifying PCR duplicates.</p>
<p>Although PCR deduplication may not affect experimental outcome in cases of calling reference variants from genome wide sequencing (<xref ref-type="bibr" rid="c3">Ebbert <italic>et al</italic>., 2016</xref>), library preparation strategies that rely on many PCR amplification cycles (such as single-cell experiments) are susceptible to errors introduced by amplification bias and should be corrected (<xref ref-type="bibr" rid="c5">Islam <italic>et al</italic>., 2014</xref>). In libraries with potentially low sequence complexity, PCR amplification bias may go undetected and lead to inaccurate interpretation of sequencing results. For example, accurate allele quantification may be distorted when identifying rare cancer mutations (<xref ref-type="bibr" rid="c7">Kinde <italic>et al</italic>., 2011</xref>; <xref ref-type="bibr" rid="c9">Kukita <italic>et al</italic>., 2015</xref>; <xref ref-type="bibr" rid="c13">Mansukhani <italic>et al</italic>., 2017</xref>) or when measuring the genomic outcomes of CRISPR genome editing experiments (<xref ref-type="bibr" rid="c14">Pinello <italic>et al</italic>., 2016</xref>) through amplicon sequencing of a specific target region.</p>
<p>In order to address the problem of duplicate reads from a biological perspective, library generation protocols have been developed that tag DNA fragments with a sequence of randomly selected nucleotides or partially degenerate nucleotides, called a unique molecular index (UMI). After sequencing, reads arising from PCR duplicates will all have the same UMI and all but one of these reads are marked as duplicates as shown in <xref rid="fig1" ref-type="fig">Figure 1a</xref>. In downstream analysis these reads are normally ignored, but they can also be used in error correction or in estimating sequencing error rates.</p>
<fig id="fig1" position="float" fig-type="figure">
<label>Fig. 1.</label>
<caption><p>a. Schematic showing utility of UMIs in identifying PCR duplicates. In libraries using UMIs, a short sequence of random nucleotides is added to each DNA fragment before PCR amplification. All PCR products of that read will contain the same UMI. After library sequencing, DNA fragments with the same sequence (shown as square nucleotides on the right part of the read) can be identified as either PCR duplicates or not, based on the UMI sequence (shown as rounded nucleotides on the left part of the read). b. Outline of a standard experiment utilizing UMI technology. The steps shown in gray are computational processing steps performed starting with raw FASTQ output from amplicon sequencing, and are the procedures performed by our software, AmpUMI.</p></caption>
<graphic xlink:href="288118v1_fig1.tif"/>
</fig>
<p>Although there are many benefits to using UMIs, there is a dearth of documented design rationale for selecting sufficient UMI length, and no existing tools to aid experimental designers who may not feel comfortable addressing the probabilities of UMI collision. In one case, a UMI length is chosen so that the number of unique UMIs &#x2018;far exceeds&#x2019; the number of primer molecules used in the experiment (<xref ref-type="bibr" rid="c8">Kou <italic>et al</italic>., 2016</xref>). However, this may lead to overestimation of the required UMI length.</p>
<p>Several tools to analyze UMI datasets are available, but most are designed for genome-wide sequencing analysis, and require aligned sequence files in bam format as input. UMI-Reducer (<xref ref-type="bibr" rid="c12">Mangul <italic>et al</italic>., 2017</xref>), Je (<xref ref-type="bibr" rid="c4">Girardot <italic>et al</italic>., 2016</xref>), Debarcer (<xref ref-type="bibr" rid="c18">Stahlberg <italic>et al</italic>., 2016</xref>), and UMI-tools (<xref ref-type="bibr" rid="c17">Smith <italic>et al</italic>., 2017</xref>) are tools that take UMI information into account in the deduplication process, but are designed for genome-wide sequencing analyses. These methods first trim the UMI and associated sequencing adapters from the sequenced read, and append the UMI to the read name. Next, the trimmed sequencing reads are mapped to the genome. Finally, each read is scanned to identify other duplicate reads that align to the same genomic location and have the same UMI. However, these existing algorithms and methods are not well-suited to amplicon sequencing, where every read aligns to same genomic position. pRESTO (<xref ref-type="bibr" rid="c22">Vander Heiden <italic>et al</italic>., 2014</xref>) and MAGERI (<xref ref-type="bibr" rid="c16">Shugay <italic>et al</italic>., 2017</xref>) have the capability to work on raw FASTQ files, and can collapse reads by unique UMIs. However, the UMI parsing capabilities for both tools are rigid and, for example, do not allow for degenerate bases in the UMI definition.</p>
<p>Additionally, existing packages attempt to minimize nucleotide variation due to sequencing error by merging reads with one or two differences between the reads (<xref ref-type="bibr" rid="c23">Xu <italic>et al</italic>., 2017</xref>). However, in some amplicon experiments, particularly those attempting to identify rare genomic variants at a locus, merging reads with small differences could obscure these rare variants. To address the problem of identifying sequencing errors, an alternate sequencing approach amplifies DNA fragments in many rounds of PCR, and then only considers sequencing reads appearing multiple times for downstream analysis (<xref ref-type="bibr" rid="c19">Stahlberg <italic>et al</italic>., 2017</xref>).</p>
<p>Our approach overcomes these challenges by providing users an end-to-end software solution for amplicon sequencing experiments called AmpUMI. AmpUMI aids in both UMI design and subsequent processing of sequencing reads to perform error correction and deduplication. (<xref rid="fig1" ref-type="fig">Figure 1b</xref>).</p>
</sec>
<sec id="s2">
<label>2</label>
<title>Approach</title>
<sec id="s2a">
<label>2.1</label>
<title>Estimating minimum UMI length requirements</title>
<p>Careful UMI design should be performed in the planning stages of an experiment, especially since it is not easy to measure the deleterious effects of inadequate UMI design after sequencing by examining the reads.</p>
<p>One of the most common problems is UMI collision, defined as the event of observing two reads with the same sequence and same UMI barcode but originating from two different genomic molecules. UMI collision is a function of the number of UMIs used, the number of unique alleles, and the frequency of each allele in the population. In genome-wide sequencing experiments, the chance of UMI collision is very low because the number of reads sharing the same sequence is very small. In this study, we focus on amplicon sequencing, in which a specific location in the genome is sequenced in many different cells, usually for the purpose of identifying or quantifying rare alleles. In this case, the sequencing depth is much greater than genome-wide sequencing and many alleles from different genomic molecules will share the same sequence. Because of this, the possibility of UMI collisions is much higher and needs to be taken into consideration in UMI design and analysis of sequenced reads.</p>
<p>In amplicon sequencing studies, it may be tempting to design conservatively long UMIs. If a long UMI is chosen, UMI diversity is high and the number of UMIs is much greater than the number of molecules of the major allele, resulting in a small UMI collision rate. In addition, if UMI diversity is high, sequencing errors that affect the UMI can be corrected. For example, if all UMIs present in a sequenced population are at least two nucleotide changes from each other, sequenced UMIs that differ by only one nucleotide change can be merged (<xref ref-type="bibr" rid="c17">Smith <italic>et al</italic>., 2017</xref>).</p>
<p>However, we note that excessively long UMI lengths chosen without consideration for these concerns pose several complications: First, a greater number of sequencer cycles spent on reading UMIs necessitates a shorter read of the actual target sequence. Second, there is some speculation that long UMIs could interfere with primer sequence binding&#x2014; by preferentially hybridizing to DNA with complementary sequence, or sterically hindering proper adapter function at the target site. Third, given that each basepair has an equal probability of sequencing error, longer UMI sequences are more likely to accumulate sequencing errors, which could result in ambiguity about whether sequences with similar UMIs result from sequencing errors or are unique molecular events.</p>
<p>To quantify the effects of UMI length on UMI collisions, we have derived an equation, <xref ref-type="disp-formula" rid="eqn4">Equation (4)</xref>, that allows us to compute the probability of observing no UMI collisions as a function of UMI length, number of reads, and the number and proportions of alleles. The calculation of this probability for the worst case is implemented in our software and can be calculated using the <monospace>AmpUMI Collision</monospace> command. In some cases, a small number of UMI collisions may be tolerable as long as the final allelic proportions are within a certain error. In this case, <xref ref-type="disp-formula" rid="eqn13">Equation (13)</xref> can be used to determine the total allelic fraction distortion for a given UMI length and the true underlying allelic composition. The calculation of allelic distortion can be computed using the <monospace>AmpUMI Distortion</monospace> command. AmpUMI can also be used to determine the minimum UMI length required to have a probability of observing a UMI collision below a given threshold, or to produce an allelic distortion below a given percentage. These commands can be accessed using the <monospace>AmpUMI Collision or AmpUMI Distortion</monospace> command as before, except that the desired cutoff is given as a parameter instead of the UMI length.</p>
<p>We note that there is a difference between the number of reads and the number of DNA fragments being sampled. While it is relatively easy to predict the number of reads that will be produced by a sequencing run based on the machine type and the abundance of the sample among those being sequenced, it is impossible to predict the allele frequency of the most frequent allele. With this in mind, we suggest that for experiments for which the major allele frequency is not known, a suitable UMI length be chosen based on the case that the amplicon sequencing yields a single allele. In this scenario, if we assume that we have <italic>n</italic> reads, we can use the <monospace>AmpUMI Collision</monospace> command or <xref ref-type="disp-formula" rid="eqn6">Equation (6)</xref> to determine the minimum UMI length <italic>k</italic> for observing no collisions with a given probability <italic>p</italic>.</p>
</sec>
<sec id="s2b">
<label>2.2</label>
<title>AmpUMI: Removing PCR duplicates from amplicon sequencing</title>
<p>Once the proper UMI length has been designed and the experiment has been sequenced, the raw FASTQ output from the sequencer needs to be prepared for downstream analysis. In addition to aiding in UMI design, AmpUMI is a flexible and efficient software that can be used to perform preparation of raw FASTQ files. FASTQ files contain the sequence of the UMI and DNA fragment, as well as the sequencing quality for each read. Unprocessed FASTQ files cannot be used in downstream processing steps because the data still contains PCR duplicates, and the UMI sequence must be separated from the sequence of the DNA fragment. AmpUMI performs four major preprocessing functions: assessing the quality of UMIs, flexible trimming of the UMI and adapter sequences, performing sequencing error correction, and finally removing reads resulting from PCR duplicates.</p>
<p>First, AmpUMI assesses the quality of UMIs. In this step, the diversity of UMIs is measured. If one or a few UMIs are significantly overrepresented in the library, this could signal an error in UMI synthesis or bias in library amplification. In addition, we propose a measure for estimating whether the UMI complexity was sufficient for the diversity of amplicon sequences. We report the frequency of reads with the same UMI that have different amplicon sequences. A high frequency of these types of reads would result from an experiment with too little UMI complexity, or from a highly error-prone sequencing run.</p>
<p>Next, the UMIs and adapter sequences are trimmed from the FASTQ sequences. AmpUMI allows users to specify a regular expression to flexibly specify the UMI and adapter sequences. In the specification of this regular expression, the locations of bases that should be counted as UMIs are set by the user as the letter <italic>I</italic>, while the sequencing adapter is specified using the regular <italic>A</italic>, <italic>T</italic>, <italic>C</italic>, and <italic>G</italic> letters. Using this regular expression, the UMI and adapter are identified and trimmed from each read. The UMI for each sequence is added to the sequence name. Reads for which the regular expression cannot be found (e.g., due to sequencing errors in the sequencing adapter or length modifications of the UMI) are discarded.</p>
<p>After the reads are trimmed, sequencing error correction and PCR deduplication are performed. Two functions for error correction are used in the deduplication process. The first type of error correction is designed for experiments in which the number of UMIs is much greater than the number of input molecules and multiple rounds of PCR have been performed. This experimental design will yield multiple copies of each UMI-molecule pair, and sequencing errors will be apparent as rare mutations in the amplicon sequence. During deduplication, reads will be grouped by UMI, and the most frequent amplicon sequence will be accepted as the consensus sequence and the other sequences will be assumed to come from sequencing error and will be discarded. The second type of error correction is optional and can be used to correct errors in the UMI sequence by filtering rare UMI-amplicon sequence pairs that could arise from sequencing errors. First, FASTQ sequences with the same UMI and amplicon sequence are grouped. Only pairs of UMI-amplicon sequence that have been seen multiple times (a parameter specified by the user) are used for downstream analysis, while the remainder of rare UMI-amplicon sequence pairs are discarded. As this parameter is increased, the confidence in the UMI and amplicon sequence is increased, but the quantification accuracy of allele distribution is decreased, especially for rare alleles.</p>
</sec>
</sec>
<sec id="s3">
<label>3</label>
<title>Methods</title>
<sec id="s3a">
<label>3.1</label>
<title>Problem formulation and assumptions</title>
<p>We are interested in determining the probability of no collisions of any two different alleles associated with the same UMI. In what follows, we make a few motivated assumptions to derive a closed-form expression for our probability of interest.</p>
<p>Let <italic>X</italic> be finite set of <italic>M</italic> (&#x003D; |<italic>X</italic>|) DNA fragments partitioned into <italic>I</italic> types (i.e. alleles) and let <italic>Y</italic> be a finite set of <italic>U</italic> (&#x003D; |<italic>Y</italic>|) UMI primers partitioned into <italic>J</italic> UMIs (i.e. barcodes), such that fragments or UMI primers within each class are indistinguishable from each other. Here, the number of UMIs <italic>J</italic> equals the number of the four nucleotides (A, G, C, T) raised to the power of the UMI&#x2019;s sequence length <italic>K</italic>. That is, <italic>J</italic> &#x003D; 4<sup><italic>K</italic></sup>, where the value of <italic>K</italic> usually ranges from 8 to 12bp. Accordingly, the two sets of interest can be partitioned into <italic>X</italic> &#x003D; {<italic>X</italic><sub>1</sub>, &#x2026;, <italic>X</italic><sub><italic>i</italic></sub>, &#x2026;, <italic>X</italic><sub><italic>I</italic></sub>} and <italic>Y</italic> &#x003D; {<italic>Y</italic><sub>1</sub>, &#x22C5;, <italic>Y</italic><sub><italic>j</italic></sub>, &#x22C5;, <italic>Y</italic><sub><italic>J</italic></sub>} where |<italic>X</italic><sub><italic>i</italic></sub>| &#x003D; <italic>M</italic><sub><italic>i</italic></sub> for <italic>i</italic> &#x003D; 1, &#x2026;, <italic>I</italic> and |<italic>Y</italic><sub><italic>j</italic></sub>| &#x003D; <italic>U</italic><sub><italic>j</italic></sub> for <italic>j</italic> &#x003D; 1, &#x2026;, <italic>J</italic>.</p>
<sec id="s3a1">
<title>Assumption 1 (Sampling with Replacement)</title>
<p>Given that the total number of UMI primers <italic>U</italic> is much greater than the number of unique UMIs <italic>J</italic> and the total number of DNA fragments <italic>M</italic> is also much greater than the number of alleles <italic>I</italic>, we can assume that both the UMI primers and DNA fragments are sampled with replacement. Note that the number of reads (samples) <italic>n</italic>, which we introduce later, is also assumed to be much less than <italic>U</italic>. For the UMIs, the assumption is motivated by the observation that in the PCR amplification step, there are typically 3 &#x00D7; 10<sup>11</sup> UMI-labeled primers in 0.5 pmol of solution and so for UMIs of length <italic>K</italic> &#x003D; 10, we would, on average, have approximately 286,100 copies for each UMI.</p>
<p>Assumption (1) implies that the probability of sampling either allele <italic>i</italic> or UMI <italic>j</italic> is given by the categorical distribution (a generalization of the Bernoulli distribution to multiple categories). That is
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn1.gif"/></alternatives>
</disp-formula>
where <italic><bold>x</bold></italic> &#x2208; {1, 2,&#x2026;, <italic>I</italic>}, <italic><bold>m</bold></italic> &#x003D; (<italic>m</italic><sub>1</sub>,&#x2026;, <italic>m</italic><sub><italic>I</italic></sub>), <italic><bold>y</bold></italic> &#x2208; {1, 2,&#x2026;, <italic>J</italic>}, and <italic><bold>u</bold></italic> &#x003D; (<italic>u</italic><sub>1</sub>,&#x2026;, <italic>u</italic><sub><italic>J</italic></sub>). The proportion <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline1.gif"/></alternatives></inline-formula> represents the probability of observing allele <italic>i</italic> such that <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline2.gif"/></alternatives></inline-formula>. Similarly, the proportion <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline3.gif"/></alternatives></inline-formula> represents the probability of observing UMI <italic>j</italic> such that <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline4.gif"/></alternatives></inline-formula>.</p>
<p>Now, the total number of reads (samples) <italic>n</italic> equals the number of UMI-allele pairs&#x2014;of which there are <italic>Q</italic> &#x003D; |&#x03A9;| &#x003D; <italic>I</italic> &#x00D7;<italic>J</italic> unique combinations. To determine the distribution over unique UMI-allele pairs, we first define a joint sample space &#x03A9; &#x003D; {(1, 1), (1, 2),&#x2026;, (<italic>i, j</italic>),&#x2026; (<italic>I, J</italic>)} to enumerate all <italic>Q</italic> possible pairing outcomes and we let the random variable <italic><bold>z</bold></italic> be defined over &#x03A9;.</p>
</sec>
<sec id="s3a2">
<title>Assumption 2 (Independence)</title>
<p>Since there is no indication that a given UMI has a preference for any allele, we can assume that the pairing process is unbiased such that sampling <italic><bold>x</bold></italic> is independent of sampling <italic><bold>y</bold></italic>.</p>
<p>Assumption (2) implies that the probability mass function for <italic><bold>z</bold></italic> is given by a multinomial distribution with support <italic><bold>z</bold></italic> &#x003D; {(<italic>z</italic><sub>1</sub>,&#x2026;, <italic>z</italic><sub><italic>Q</italic></sub>) &#x2208; &#x2115;<sup><italic>Q</italic></sup> |<italic>z</italic><sub>1</sub> &#x002B; &#x2026; &#x002B; <italic>z</italic><sub><italic>Q</italic></sub> &#x003D; <italic>n</italic>} where <italic>n</italic> is the number of samples and <italic><bold>p</bold></italic> &#x003D; <italic><bold>m</bold></italic> &#x2A02; <italic><bold>u</bold></italic> &#x003D; [<italic>m</italic><sub>1</sub><italic>u</italic><sub>1</sub>,&#x2026;, <italic>m</italic><sub>1</sub><italic>u</italic><sub><italic>j</italic></sub>,&#x2026; <italic>m</italic><sub><italic>i</italic></sub><italic>u</italic><sub><italic>j</italic></sub>,&#x2026; <italic>m</italic><sub><italic>I</italic></sub><italic>u</italic><sub><italic>J</italic></sub>] is the probability vector for the <italic>Q</italic> possible pairings, where &#x2A02; is the Kronecker product. That is,
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn2.gif"/></alternatives>
</disp-formula></p>
<sec id="s3a2a">
<title>Example</title>
<p>For the case of two alleles <italic>I</italic> &#x003D; 2, three UMIs <italic>J</italic> &#x003D; 3, and three observations (i.e. reads) <italic>n</italic> &#x003D; 3, the probability of observing two reads from Allele 1 paired with UMI 1 and one read from Allele 2 paired with UMI 3 is
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn3.gif"/></alternatives>
</disp-formula></p>
<p>To derive the probability of obtaining no collisions, we note that the multinomial distribution for a sample size <italic>n</italic> can be viewed geometrically as the normalized <italic>n</italic>&#x2019;th component of a <italic>Q&#x2212;</italic>dimensional Pascal&#x2019;s simplex, &#x2227;<sup><italic>Q</italic></sup>, whose <italic>n</italic>&#x2019;th component, <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline5.gif"/></alternatives></inline-formula>, consists of the coefficients of the multinomial expansion of the polynomial <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline6.gif"/></alternatives></inline-formula> raised to the power <italic>n</italic>. In particular, according to the multinomial theorem, we have
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn4.gif"/></alternatives>
</disp-formula>
where <italic><bold>p</bold> &#x2208;</italic> [0, 1]<sup><italic>Q</italic></sup>, <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline7.gif"/></alternatives></inline-formula>, <italic>n</italic> &#x2208; &#x2115;<sub>0</sub>, <italic>Q</italic> &#x2208; &#x2115;, and ||<italic><bold>p</bold></italic>||<sub>1</sub> &#x003D; 1.</p>
<p>Therefore, the number of multinomial coefficients is equal to the number of coefficients in the (<italic>Q &#x2212;</italic> 1) simplex <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline8.gif"/></alternatives></inline-formula> and is given by the (<italic>n</italic> &#x002B; 1)th simplicial (<italic>Q &#x2212;</italic> 1)-polytopic number
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn5.gif"/></alternatives>
</disp-formula></p>
<p>Each of the <italic>S</italic> components of the multinomial expansion represents the probability of a particular counts outcome event (i.e.<italic><bold>z</bold></italic> &#x003D; <italic>z</italic>), which is given by the multinomial distribution
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn6.gif"/></alternatives>
</disp-formula></p>
<p>We are interested in a subset of the <italic>S</italic> events that correspond to having no collisions. We denote the set of no collisions by
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn7.gif"/></alternatives>
</disp-formula></p>
<p>Note that the cardinality of &#x1D4AF; is equal to the number of ways a total of <italic>n</italic> 1s are selected from a group of <italic>n</italic> 1s and (<italic>Q &#x2212; n</italic>) 0s. More specifically,
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn8.gif"/></alternatives>
</disp-formula></p>
<p>Now since for all T events, the product of the terms in denominator of multinomial coefficient is equal to 1, we can simplify the expression for the probability of observing <italic><bold>z</bold></italic>&#x002A; &#x2208; &#x1D4AF; as such
<disp-formula id="eqn1">
<alternatives><graphic xlink:href="288118v1_eqn1.gif"/></alternatives>
</disp-formula></p>
<p>Note that when <italic>n &#x003E; Q</italic>, the probability of observing any of the <italic>T</italic> no-collision events is zero, otherwise when <italic>n &#x2264; Q</italic> the probability of observing no collision can be expressed concisely as
<disp-formula id="eqn2">
<alternatives><graphic xlink:href="288118v1_eqn2.gif"/></alternatives>
</disp-formula></p>
</sec>
</sec>
<sec id="s3a3">
<title>Assumption 3 (Equal Proportions of UMIs)</title>
<p>Since the relative abundance of UMIs can be controlled during UMI synthesis, we can assume that the proportion of UMIs to be uniform such that <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline9.gif"/></alternatives></inline-formula> for all <italic>j, j</italic> &#x003D; 1,&#x2026; <italic>J</italic>.</p>
<p>Assumption (3) allows us to further simplify <xref ref-type="disp-formula" rid="eqn1">Equation (1)</xref> as such
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn9.gif"/></alternatives>
</disp-formula>
and so the probability of observing any of the <italic>T</italic> no-collision events, <xref ref-type="disp-formula" rid="eqn2">Equation (2)</xref>, becomes
<disp-formula id="eqn3">
<alternatives><graphic xlink:href="288118v1_eqn3.gif"/></alternatives>
</disp-formula></p>
<p>Computing the probability given by <xref ref-type="disp-formula" rid="eqn3">Equation (3)</xref> is intractable for large values of <italic>T</italic>. Nonetheless, the expression can further be simplified if we assume the following.</p>
</sec>
<sec id="s3a4">
<title>Assumption 4 (Upper Limit on the Number of Reads)</title>
<p>When the UMI sequence length <italic>K</italic> is 10, <italic>J</italic> already exceeds 1 million. For some experiments then, we can assume that the number of reads is less than or equal to the number of UMIs <italic>n</italic> &#x2264; <italic>J</italic></p>
<p>Using Assumption (4), we can partition the set &#x1D4AF; into <italic>E</italic> equivalent classes, essentially reducing the set into an <italic>I</italic>-dimensional <italic>discrete simplex</italic>
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn10.gif"/></alternatives>
</disp-formula>
with cardinality
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn11.gif"/></alternatives>
</disp-formula>
such that
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn12.gif"/></alternatives>
</disp-formula>
so now the probability of observing any of the <italic>T</italic> no-collision events is given by this general formula.
<disp-formula id="eqn4">
<alternatives><graphic xlink:href="288118v1_eqn4.gif"/></alternatives>
</disp-formula></p>
</sec>
</sec>
<sec id="s3b">
<label>3.2</label>
<title>Special cases</title>
<sec id="s3b1">
<title>Case 1 (One Allele (<italic>I</italic> &#x003D; 1, Worst Case))</title>
<p>When <italic>I</italic> &#x003D; 1, the discrete simplex <italic>&#x03B5;</italic> has just a single component. Subsequently, <xref ref-type="disp-formula" rid="eqn4">Equation (4)</xref> reduces to
<disp-formula id="eqn5">
<alternatives><graphic xlink:href="288118v1_eqn5.gif"/></alternatives>
</disp-formula></p>
<p>To find the minimum UMI length <italic>k&#x002A;</italic> for a given sample size <italic>n&#x002A;</italic> such the probability of no collisions is above a certain threshold <italic>p&#x002A;</italic>, we first need to compute the quantity given by <xref ref-type="disp-formula" rid="eqn5">Equation (5)</xref> for a given <italic>n&#x002A;</italic> for each UMI length up to an upper bound <italic>k</italic><sub><italic>max</italic></sub> (say 20). Let us denote the vector of computed probabilities by
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn13.gif"/></alternatives>
</disp-formula></p>
<p>Note the elements of <italic><bold>&#x03C0;</bold></italic> corresponding to values of <italic>K</italic> for which <italic>n &#x003C;</italic> 4<sup><italic>K</italic></sup> are zero and do not require computing. The minimum UMI length <italic>k&#x002A;</italic> can then be formally written as
<disp-formula id="eqn6">
<alternatives><graphic xlink:href="288118v1_eqn6.gif"/></alternatives>
</disp-formula>
where arg where(<italic><bold>&#x03C0;</bold>, p&#x002A;</italic>) gives back the index of the first vector&#x2019;s element whose value exceeds <italic>p&#x002A;</italic>. Note that since the value of <italic>&#x03C0;</italic><sub><italic>i</italic></sub> increases as <italic>i &#x2192; k</italic><sub><italic>max</italic></sub>, we only need to return the index of the first element exceeding the threshold.</p>
</sec>
<sec id="s3b2">
<title>Case 2 (Equal Proportion of Alleles)</title>
<p><xref ref-type="disp-formula" rid="eqn3">Equations (3)</xref> and <xref ref-type="disp-formula" rid="eqn4">(4)</xref> have the simplest form when <italic><bold>m</bold></italic> is a vector of equal probabilities. That is, when <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline10.gif"/></alternatives></inline-formula> for all <italic>i</italic>, <italic>i</italic> = 1, &#x2026; <italic>I</italic>. The probability of observing any of the <italic>T</italic> no-collision events simplifies as such.
<disp-formula id="eqn7">
<alternatives><graphic xlink:href="288118v1_eqn7.gif"/></alternatives>
</disp-formula>
where (<italic>Q</italic>)<sub><italic>n</italic></sub> denotes the falling factorial. Note that the probability of no collision approaches 0 very rapidly as <italic>n</italic> goes from 1 to <italic>Q</italic>. Also, note that when <italic>n &#x003E; Q</italic>, the probability of collision is 1 for any <italic>Q</italic>.</p>
<p>Note that whereas the number of multinomial coefficients is given by <italic>S</italic> for the set of all events and <italic>T</italic> for the set of no-collision events, the sum of the coefficients is given by <italic>A</italic> &#x003D; <italic>Q</italic><sup><italic>n</italic></sup> for the set of all events and by
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn14.gif"/></alternatives>
</disp-formula>
for the set of no collisions. Alternatively, the probability can be derived as a ratio of B over A
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn15.gif"/></alternatives>
</disp-formula></p>
</sec>
<sec id="s3b3">
<title>Case 3 (Two Alleles (<italic>I</italic> &#x003D; 2))</title>
<p>When <italic>I</italic> &#x003D; 2, the discrete simplex <italic>&#x03B5;</italic> has has <italic>n</italic> components. Subsequently, <xref ref-type="disp-formula" rid="eqn4">Equation (4)</xref> reduces to
<disp-formula id="eqn8">
<alternatives><graphic xlink:href="288118v1_eqn8.gif"/></alternatives>
</disp-formula>
where the values of <italic><bold>r</bold></italic> &#x003D; (<italic>n</italic><sub>1</sub>, <italic>n</italic><sub>2</sub>) vary over the anti-diagonal indices of an <italic>n &#x00D7; n</italic> matrix and the discrete simplex is given by
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn16.gif"/></alternatives>
</disp-formula></p>
</sec>
</sec>
<sec id="s3c">
<label>3.3</label>
<title>Effects of Collisions on Allelic Diversity</title>
<p>Let <italic><bold>y</bold></italic> &#x003D; (<italic>y</italic><sub>11</sub>,&#x2026;, <italic>y</italic><sub>1<italic>J</italic></sub>,&#x2026;, <italic>y</italic><sub><italic>I</italic>1</sub>,&#x2026;, <italic>y</italic><sub><italic>IJ</italic></sub>) denote the <italic>q</italic>-dimensional vector of deduplicated reads for all UMI-allele pairing such that <italic>y</italic><sub><italic>ij</italic></sub> &#x2208; {0, 1} refers to the read corresponding to the <italic>i</italic>th allele and <italic>j</italic>th UMI. The model, where an indicator function <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline11.gif"/></alternatives></inline-formula> thresholds each element of the unobservable random vector <italic><bold>z</bold></italic> into an observable binary variable <italic>y</italic><sub><italic>ij</italic></sub>.</p>
<p>That is,
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn17.gif"/></alternatives>
</disp-formula>
where <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline12.gif"/></alternatives></inline-formula>, ||<bold><italic>z</italic></bold>||<sub>1</sub> &#x003D; <italic>n</italic>, <bold><italic>p</italic></bold> &#x2208; [0, 1]<sup><italic>Q</italic></sup>, ||<italic><bold>p</bold></italic>||<sub>1</sub> &#x003D; 1, <italic>n</italic> &#x2208; &#x2115;<sub>0</sub>,, and <italic>Q</italic> &#x003D; (<italic>I &#x00D7; J</italic>) <italic>&#x2208;</italic> &#x2115;</p>
<sec id="s3c1">
<title>Expected Number of Deduplicated Reads</title>
<p>We are interested in the expected number of deduplicated reads (i.e. one-valued elements) in each of the <italic>I</italic> allele partitions of <italic><bold>y</bold></italic>. We begin by letting <bold>M</bold> denote the <italic>I &#x00D7;</italic>(<italic>I &#x00D7;J</italic>) transformation matrix that gives the <italic>I</italic>-dimensional vector of deduplicated read counts for each allele. That is,
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn18.gif"/></alternatives>
</disp-formula></p>
<p>Accordingly, the vector of expected deduplicated read counts <italic><bold>c</bold></italic> can be obtained as such
<disp-formula id="eqn9">
<alternatives><graphic xlink:href="288118v1_eqn9.gif"/></alternatives>
</disp-formula></p>
<p>The penultimate step was obtained by observing that the expectation of an event defined by an indicator function is equal to the probability of that event. That is
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn19.gif"/></alternatives>
</disp-formula></p>
<p>The final step was obtained by noting that since the marginal distribution of each element of the multinomial <italic><bold>z</bold></italic> is binomial, namely,
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn20.gif"/></alternatives>
</disp-formula>
then the probabilities of interest are just given as such.
<disp-formula>
<alternatives><graphic xlink:href="288118v1_ueqn21.gif"/></alternatives>
</disp-formula></p>
<sec id="s3c1a">
<title>Expected Number of Collisions</title>
<p>The expected number of collisions <italic><bold>n</bold></italic><sub><italic>c</italic></sub> can be computed by noting that the number of collisions for each UMI-allele pairing is given by the vector <italic><bold>x</bold></italic> &#x003D; <italic><bold>z</bold> &#x2212; <bold>y</bold></italic> and so the vector of expected number of collisions for all the alleles is given by
<disp-formula id="eqn10">
<alternatives><graphic xlink:href="288118v1_eqn10.gif"/></alternatives>
</disp-formula></p>
<p>Furthermore, the expected total number of collisions collapsed over the alleles is given by
<disp-formula id="eqn11">
<alternatives><graphic xlink:href="288118v1_eqn11.gif"/></alternatives>
</disp-formula></p>
</sec>
<sec id="s3c1b">
<title>Allelic Fraction Distortion</title>
<p>The expected allelic fraction distortion is simply the difference of the two normalized components of <italic><bold>n</bold></italic><sub><bold><italic>c</italic></bold></sub>. More specifically, since the elements <italic><bold>c</bold></italic> are all non-negative, we can formally define and simplify the quantity as such.
<disp-formula id="eqn12">
<alternatives><graphic xlink:href="288118v1_eqn12.gif"/></alternatives>
</disp-formula>
which can be reduced to a scalar quantity, the expected total allelic fraction distortion, which we abbreviate as <bold>TAFD</bold> and can be obtained as such.
<disp-formula id="eqn13">
<alternatives><graphic xlink:href="288118v1_eqn13.gif"/></alternatives>
</disp-formula></p>
</sec>
</sec>
</sec>
</sec>
<sec id="s4">
<label>4</label>
<title>Results</title>
<sec id="s4a">
<label>4.1</label>
<title>Allelic fraction distortion resulting from inadequate UMI length</title>
<p>One of the purposes of performing amplicon sequencing is to accurately estimate the frequency of each allele variant in the population. However, we show here that the observed allelic fraction of each variant can be distorted if the UMI length is too short and the UMI complexity is too low. In the case in which allele variants are present at roughly the same proportion in the population (<italic>m</italic><sub>1</sub> <italic>&#x2248; m</italic><sub>2</sub> <italic>&#x2248; m</italic><sub>3</sub> <italic>&#x2248; m</italic><sub><italic>I</italic></sub>) this distortion will be small, as UMI-molecule collisions will affect each molecule type equally. However, as the proportion of allele variants becomes more imbalanced (e.g., <italic>m</italic><sub>1</sub> &#x226B; <italic>m</italic><sub>2</sub> &#x226B; <italic>m</italic><sub>3</sub> &#x2026;), after deduplication using UMIs the observed frequency of rare alleles will increase, and the observed frequency of frequent alleles will be lower than the actual frequency in the population. Intuitively, this is because collisions are more frequent in the more frequent alleles, where a larger UMI diversity is required to avoid UMI-molecule collisions. Rare allele with few reads are less likely to exhaust the available unique UMIs.</p>
<p>As an example, we simulated biological library preparations with <italic>n</italic> &#x003D;100,000 reads from a population with an underlying allelic diversity defined as <italic><bold>m</bold></italic> &#x003D; (0.1, 0.1, 0.3, 0.5). In each simulation, alleles were paired with a UMI. Samples were simulated using UMIs of length between 1 and 18bp long. After the simulated sample was assembled, reads with the same UMI and allele were deduplicated, leaving only one unique UMI-allele combination in the sample. The proportion of each allele was reported. As seen in <xref rid="fig2" ref-type="fig">Figure 2</xref>, if the UMI is too short and UMI complexity is too low then the proportion of each allele, including rare alleles will be approximately equal. This has the effect of overestimating the frequency of rare alleles in the population, while underestimating the frequency of abundant alleles as shown on the left side of <xref rid="fig2" ref-type="fig">Figure 2</xref>. With sufficient UMI diversity (right side of <xref rid="fig2" ref-type="fig">Figure 2</xref>), the true, underlying allele frequencies are recapitulated in the simulated, deduplicated populations. As expected, the allelic frequencies produced by our model are in perfect agreement with those obtained with computationally expensive simulations.</p>
<fig id="fig2" position="float" fig-type="figure">
<label>Fig. 2.</label>
<caption><p>Association between distortion of allelic frequency and UMI length. Colored bars show simulated allelic fractions of four alleles after deduplication of reads with the same UMI and allele. Simulated samples consisted of <italic>n</italic> &#x003D;100,000 reads and were drawn from a population with an allelic diversity given by <italic><bold>m</bold></italic> &#x003D; (0.1, 0.1, 0.3, 0.5). Reads were generated using using UMI of length between 1 and 18bp long. For each UMI length, the average simulation proportion of each allele is shown after removing UMI-allele collisions. 100 samples were simulated for each UMI length. The right column marked &#x2018;Truth&#x2019; shows the underlying allelic diversity from which the simulated samples were drawn. Dots connected by lines show the predicted allele frequency given our model (<xref ref-type="disp-formula" rid="eqn12">Equation (12)</xref>) and are in complete concordance with the simulation results. The gray histogram at the bottom of the plot shows the total allelic fraction distortion (TAFD) (<xref ref-type="disp-formula" rid="eqn13">Equation (13)</xref>) for each UMI length.</p></caption>
<graphic xlink:href="288118v1_fig2.tif"/>
</fig>
<p>We then considered the number of collisions in our simulated samples (<xref rid="fig3" ref-type="fig">Figure 3</xref>). The number of collisions is defined as the number of simulated reads (UMI-molecule combination) that had been previously observed in the simulation. For example, We simulated 100,000 reads with a UMI of length 1 (4 possible UMIs), and measured the collision rate as <inline-formula><alternatives><inline-graphic xlink:href="288118v1_inline13.gif"/></alternatives></inline-formula>. We note that the accuracy of recapitulating the actual allele fraction as shown in <xref rid="fig2" ref-type="fig">Figure 2</xref> is mirrored in the collision rate shown in <xref rid="fig3" ref-type="fig">Figure 3</xref>.</p>
<fig id="fig3" position="float" fig-type="figure">
<label>Fig. 3.</label>
<caption><p>Distribution of collisions in simulated populations. The number of collisions in each simulated sample used in <xref rid="fig2" ref-type="fig">Figure 2</xref> were aggregated by UMI length. Boxplots show the median (thick line), interquartile range (box), and the range of the data (whiskers). The count of collisions is defined as the number of simulated reads (UMI-molecule combination) that had already been observed in the simulation.</p></caption>
<graphic xlink:href="288118v1_fig3.tif"/>
</fig>
</sec>
<sec id="s4b">
<label>4.2</label>
<title>Probability of observing no UMI collisions</title>
<p>Next, we address the problem of finding the probability of observing no UMI collisions. <xref ref-type="disp-formula" rid="eqn5">Equation (5)</xref> describes the probability of observing no collisions in the worst case scenario in which we are most likely to observe a UMI collision&#x2014;when only one allele is present in our DNA fragment pool. <xref rid="fig4" ref-type="fig">Figure 4</xref> shows the probability of having no UMI collisions for a variety of UMI lengths. When we construct 100,000 reads consisting of a random UMI and a DNA fragment, an 18bp UMI yields a sample with no collisions with probability p&#x003D;0.93, while shorter UMIs are less likely to yield a sample with no collisions.</p>
<fig id="fig4" position="float" fig-type="figure">
<label>Fig. 4.</label>
<caption><p>Probability of having no UMI collisions for Case 2 (worst case scenario): The probability of no collision as a function of sample size <italic>n</italic> for 5 consecutive values of UMI lengths, <italic>k</italic> &#x003D; 14,&#x2026;, 18 such that <italic>J</italic> &#x003D; 4<sup><italic>k</italic></sup> &#x2264; <italic>n</italic> (colored curves). The vertical dotted line shows the n&#x003D;100,000 sample size referenced in <xref rid="fig2" ref-type="fig">Figures 2</xref> and <xref rid="fig5" ref-type="fig">5</xref>.</p></caption>
<graphic xlink:href="288118v1_fig4.tif"/>
</fig>
<sec id="s4b1">
<label>4.3</label>
<title>Rates of no UMI collisions in simulated samples</title>
<p>We wanted to validate our model with simulated data, so we simulated samples of size <italic>n</italic> &#x003D;100000 with a UMI of length between 6bp and 17bp long. For each simulation sample, we simulated a set of DNA fragments consisting of five different alleles. The fractional presence of each allele was randomly selected for each simulation sample to explore collision rates in cases without prior knowledge on allelic composition of a sample. DNA fragments were paired with UMIs and the number of UMI collisions was recorded. A total of 1000 simulations were performed for each UMI length. <xref rid="fig5" ref-type="fig">Figure 5</xref> shows the average percent of simulated samples in which no UMI collisions were recorded. The red line in this figure shows the predicted probability for the worst case in which there is only one type of molecule. As expected, the model-predicted worst case (red line) is always below the average of all simulated samples (blue lines) for every UMI length.</p>
<fig id="fig5" position="float" fig-type="figure">
<label>Fig. 5.</label>
<caption><p>Probability of having no UMI collisions in simulated samples. We simulated samples of size <italic>n</italic> &#x003D;100000, with DNA fragments randomly selected from a set containing 5 unique fragments each with a random fraction of presence in the sample. Simulated DNA fragments were paired with a given set of UMIs, and the rate of UMI collisions were measured. The average percent of all 1000 simulated samples having no collisions is shown with the blue line. 3 simulations were carried out with 1000 samples each. The red reference line is computed by our model, and shows the values in <xref rid="fig4" ref-type="fig">Figure 4</xref>.</p></caption>
<graphic xlink:href="288118v1_fig5.tif"/>
</fig>
<p>We were surprised to observe that the length of UMI required to achieve no UMI collisions was so long&#x2014;with a minimum of 18bp long for a sample of 100,000 DNA fragments. This indicates that for experiments performed with this number of fragments and a shorter UMI (length 8bp or length 12bp), a small number of undetectable PCR duplicates are likely present in these libraries.</p>
<p>We note that the probability of having no collisions may be somewhat conservative for some experimentalists who may have a certain tolerance for an allowable number of collisions in an amplicon sequencing experiment. In this case, <xref ref-type="disp-formula" rid="eqn13">Equation (13)</xref> or the <monospace>AmpUMI Distortion</monospace> command can be used to determine the required UMI length after selecting a tolerable allelic distortion for their sequencing application.</p>
</sec>
<sec id="s4b2">
<label>4.4</label>
<title>AmpUMI validation on experimental data</title>
<p>To validate our deduplication software, we analyzed a publicly-available dataset of deep amplicon sequencing (<xref ref-type="bibr" rid="c8">Kou <italic>et al</italic>., 2016</xref>). This dataset was created to measure PCR amplification and sequencing errors, and utilized a 22bp UMI. The amplicon sequence was verified by Sanger sequencing to match the reference sequence. We tested to see whether AmpUMI could correctly remove erroneous, non-reference reads. <xref rid="tbl1" ref-type="table">Table 1</xref> shows data for the unprocessed data and after the first and second steps of data processing using AmpUMI. In Step 1, reads with the same UMI are deduplicated, and only the most-frequent allele is kept for each UMI. In Step 2, UMI-sequence pairs that appear less than 10 times are filtered out. <xref rid="tbl1" ref-type="table">Table 1</xref> shows the number of total reads, the number of unique alleles, and the percentage of reads that represent the true, unmodified, reference allele. Although only 95.77&#x0025; of reads in the unprocessed sample match the unmodified allele sequence (the remainder of reads contain PCR and sequencing artifacts), after both steps of processing by AmpUMI, 99.19&#x0025; of reads match the unmodified allele, showing a substantial reduction in contaminating reads resulting from PCR or sequencing artifacts.</p>
<table-wrap id="tbl1" orientation="portrait" position="float">
<label>Table 1.</label>
<caption><p>Number of reads, alleles, and the percent of reads matching the reference allele that are present before and after AmpUMI analysis of a dataset of deep amplicon sequencing (<xref ref-type="bibr" rid="c8">Kou et al., 2016</xref>).</p></caption>
<graphic xlink:href="288118v1_tbl1.tif"/>
</table-wrap>
</sec>
</sec>
</sec>
<sec id="s5">
<label>5</label>
<title>Discussion</title>
<p>In this study, we address the problem of UMI design and outline a statistical framework for calculating the probability of collisions of different molecules having the same UMI. We also introduce AmpUMI, a flexible software for analyzing next-generation sequencing from experiments using UMIs and for preparing data for downstream analysis.</p>
<p>Our statistical framework allows researchers to calculate the probability of having no collisions for a given experiment, and can be used to determine an acceptable number of UMIs in order to reduce the probability of observing a collision to an acceptable threshold as determined by the user. In cases where a small number of UMI collisions are acceptable, our framework can also be used to estimate the allelic distortion resulting from these collisions, and an appropriate UMI length can be chosen to keep the allelic distortion below a specified threshold.</p>
<p>We show that AmpUMI is a valuable tool for analyzing amplicon sequencing using UMIs. AmpUMI first allows users to assess the quality of UMIs and to determine whether the UMI pool had adequate diversity to prevent UMI collisions. Next, flexible trimming of the UMI and adapter sequences allows researchers to adapt the software to their specific UMI and sequencing design. AmpUMI can also performing sequencing error correction to reduce noise and mitigate sequencing errors. Finally PCR duplicate reads are removed from the sample FASTQ for easy integration into downstream analysis.</p>
<p>Although many analysis tools exist for deduplicating next-generation sequencing data, none are designed to use UMI information for deep amplicon sequencing in cases where preservation of allelic frequency is important. AmpUMI will fill a gap in the available analysis tools that are currently available to the community. We anticipate that this tool will be useful in a variety of applications. For example, in the genome editing community, much effort is being placed on the quantification and characterization of CRISPR activity in the genome and the identification of off-targets (<xref ref-type="bibr" rid="c20">Tsai <italic>et al</italic>., 2015</xref>; <xref ref-type="bibr" rid="c6">Kim <italic>et al</italic>., 2015</xref>; <xref ref-type="bibr" rid="c21">Tsai <italic>et al</italic>., 2017</xref>). The gold standard for analyzing mutations at targets is by deep amplicon sequencing of the target which allows for quantification of editing frequency and analyzing genetic editing events (<xref ref-type="bibr" rid="c14">Pinello <italic>et al</italic>., 2016</xref>). After performing genomic editing, the rate of modified reads is compared to the rate of unmodified reads to determine editing efficiency at that location. Because a large percent of the resulting amplicon sequences are the unmodified sequence, simply removing duplicate sequences would greatly distort the measure of editing frequency, and it is impossible to tell which sequence are arising from PCR duplication or unique molecules. Sequencing strategies that use UMIs could greatly improve the accuracy and confidence in this measure.</p>
<p>When performing amplicon sequencing on a sample with unknown allele frequency, we recommend using the collision rate calculated for a sample with only one allele, and acknowledge that this will yield a very conservative estimate of minimum UMI length. In a laboratory setting, this conservative UMI length could be used in a pilot study sequenced at low sequencing depth to better understand the underlying allele distribution, after which a more practical UMI length can be established for full-scale sequencing analysis.</p>
<p>In conclusion, we provide AmpUMI as an open source tool that we hope will benefit the scientific community, particularly in the design of appropriate UMIs and in the processing of sequencing reads produced by amplicon sequencing using UMIs. AmpUMI is open-source and freely available at <ext-link ext-link-type="uri" xlink:href="http://github.com/pinellolab/AmpUMI">http://github.com/pinellolab/AmpUMI</ext-link>.</p>
</sec>
</body>
<back>
<sec id="s6" sec-type="funding">
<title>Funding</title>
<p>L.P. is supported by the National Science Foundation National Institutes of Health R00HG008399 and the Defense Advanced Research Projects Agency HR0011-17-2-0042. D.E.B. is supported by NIDDK (R03DK109232), NHLBI (DP2OD022716, P01HL32262), Burroughs Wellcome Fund, Doris Duke Charitable Foundation, and ASH Scholar Award.</p>
</sec>
<sec id="s7">
<title>Author Contributions</title>
<p>R.F. and K.C. conceived the methodology; K.C. developed the software; R.F. developed the statistical formalism and worked out the mathematical derivations; R.F. and K.C created the visualization plots; K.C., R.F., D.E.B., and L.P. wrote, reviewed, and contributed to the final version of the manuscript; K.C., R.F., D.E.B., and L.P. conceived the ideas in the paper. L.P. supervised the project.</p>
</sec>
<ref-list>
<title>References</title>
<ref id="c1"><mixed-citation publication-type="journal"><string-name><surname>Aird</surname>, <given-names>D.</given-names></string-name> <etal>et al.</etal> (<year>2011</year>). <article-title>Analyzing and minimizing PCR amplification bias in Illumina sequencing libraries</article-title>. <source>Genome Biol.</source>, <volume>12</volume>(<issue>2</issue>), <fpage>R18</fpage>.</mixed-citation></ref>
<ref id="c2"><mixed-citation publication-type="journal"><string-name><surname>Burriesci</surname>, <given-names>M. S.</given-names></string-name> <etal>et al.</etal> (<year>2012</year>). <article-title>Fulcrum: Condensing redundant reads from high-throughput sequencing studies</article-title>. <source>Bioinformatics</source>, <volume>28</volume>(<issue>10</issue>), <fpage>1324</fpage>&#x2013;<lpage>1327</lpage>.</mixed-citation></ref>
<ref id="c3"><mixed-citation publication-type="journal"><string-name><surname>Ebbert</surname>, <given-names>M. T.</given-names></string-name> <etal>et al.</etal> (<year>2016</year>). <article-title>Evaluating the necessity of PCR duplicate removal from next-generation sequencing data and a comparison of approaches</article-title>. <source>BMC Bioinformatics</source>, <volume>17 Suppl 7</volume>, <fpage>239</fpage>.</mixed-citation></ref>
<ref id="c4"><mixed-citation publication-type="journal"><string-name><surname>Girardot</surname>, <given-names>C.</given-names></string-name> <etal>et al.</etal> (<year>2016</year>). <article-title>Je, a versatile suite to handle multiplexed NGS libraries with unique molecular identifiers</article-title>. <source>BMC Bioinformatics</source>, <volume>17</volume>(<issue>1</issue>), <fpage>419</fpage>.</mixed-citation></ref>
<ref id="c5"><mixed-citation publication-type="journal"><string-name><surname>Islam</surname>, <given-names>S.</given-names></string-name> <etal>et al.</etal> (<year>2014</year>). <article-title>Quantitative single-cell RNA-seq with unique molecular identifiers</article-title>. <source>Nature Methods</source>, <volume>11</volume>(<issue>2</issue>), <fpage>163</fpage>&#x2013;<lpage>166</lpage>.</mixed-citation></ref>
<ref id="c6"><mixed-citation publication-type="journal"><string-name><surname>Kim</surname>, <given-names>D.</given-names></string-name> <etal>et al.</etal> (<year>2015</year>). <article-title>Digenome-seq: genome-wide profiling of CRISPR- Cas9 off-target effects in human cells</article-title>. <source>Nat. Methods</source>, <volume>12</volume>(<issue>3</issue>), <fpage>237</fpage>&#x2013;<lpage>243</lpage>.</mixed-citation></ref>
<ref id="c7"><mixed-citation publication-type="journal"><string-name><surname>Kinde</surname>, <given-names>I.</given-names></string-name> <etal>et al.</etal> (<year>2011</year>). <article-title>Detection and quantification of rare mutations with massively parallel sequencing</article-title>. <source>Proc. Natl. Acad. Sci. U.S.A.</source>, <volume>108</volume>(<issue>23</issue>), <fpage>9530</fpage>&#x2013;<lpage>9535</lpage>.</mixed-citation></ref>
<ref id="c8"><mixed-citation publication-type="journal"><string-name><surname>Kou</surname>, <given-names>R.</given-names></string-name> <etal>et al.</etal> (<year>2016</year>). <article-title>Benefits and Challenges with Applying Unique Molecular Identifiers in Next Generation Sequencing to Detect Low Frequency Mutations</article-title>. <source>PLoS ONE</source>, <volume>11</volume>(<issue>1</issue>), <fpage>e0146638</fpage>.</mixed-citation></ref>
<ref id="c9"><mixed-citation publication-type="journal"><string-name><surname>Kukita</surname>, <given-names>Y.</given-names></string-name> <etal>et al.</etal> (<year>2015</year>). <article-title>High-fidelity target sequencing of individual molecules identified using barcode sequences: de novo detection and absolute quantitation of mutations in plasma cell-free DNA from cancer patients</article-title>. <source>DNA Res.</source>, <volume>22</volume>(<issue>4</issue>), <fpage>269</fpage>&#x2013;<lpage>277</lpage>.</mixed-citation></ref>
<ref id="c10"><mixed-citation publication-type="journal"><string-name><surname>Li</surname>, <given-names>H.</given-names></string-name> (<year>2011</year>). <article-title>A statistical framework for SNP calling, mutation discovery, association mapping and population genetical parameter estimation from sequencing data</article-title>. <source>Bioinformatics</source>, <volume>27</volume>(<issue>21</issue>), <fpage>2987</fpage>&#x2013;<lpage>2993</lpage>.</mixed-citation></ref>
<ref id="c11"><mixed-citation publication-type="journal"><string-name><surname>Li</surname>, <given-names>H.</given-names></string-name> <etal>et al.</etal> (<year>2009</year>). <article-title>The Sequence Alignment/Map format and SAMtools</article-title>. <source>Bioinformatics</source>, <volume>25</volume>(<issue>16</issue>), <fpage>2078</fpage>&#x2013;<lpage>2079</lpage>.</mixed-citation></ref>
<ref id="c12"><mixed-citation publication-type="journal"><string-name><surname>Mangul</surname>, <given-names>S.</given-names></string-name> <etal>et al.</etal> (<year>2017</year>). <article-title>Umi-reducer: Collapsing duplicate sequencing reads via unique molecular identifiers</article-title>. <source>bioRxiv</source>.</mixed-citation></ref>
<ref id="c13"><mixed-citation publication-type="journal"><string-name><surname>Mansukhani</surname>, <given-names>S.</given-names></string-name> <etal>et al.</etal> (<year>2017</year>). <article-title>Ultra-sensitive mutation detection and genome-wide dna copy number reconstruction by error corrected circulating tumour dna sequencing</article-title>. <source>bioRxiv</source>.</mixed-citation></ref>
<ref id="c14"><mixed-citation publication-type="journal"><string-name><surname>Pinello</surname>, <given-names>L.</given-names></string-name> <etal>et al.</etal> (<year>2016</year>). <article-title>Analyzing CRISPR genome-editing experiments with CRISPResso</article-title>. <source>Nat. Biotechnol.</source>, <volume>34</volume>(<issue>7</issue>), <fpage>695</fpage>&#x2013;<lpage>697</lpage>.</mixed-citation></ref>
<ref id="c15"><mixed-citation publication-type="journal"><string-name><surname>Pireddu</surname>, <given-names>L.</given-names></string-name> <etal>et al.</etal> (<year>2011</year>). <article-title>SEAL: a distributed short read mapping and duplicate removal tool</article-title>. <source>Bioinformatics</source>, <volume>27</volume>(<issue>15</issue>), <fpage>2159</fpage>&#x2013;<lpage>2160</lpage>.</mixed-citation></ref>
<ref id="c16"><mixed-citation publication-type="journal"><string-name><surname>Shugay</surname>, <given-names>M.</given-names></string-name> <etal>et al.</etal> (<year>2017</year>). <article-title>MAGERI: Computational pipeline for molecular-barcoded targeted resequencing</article-title>. <source>PLoS Comput. Biol.</source>, <volume>13</volume>(<issue>5</issue>), <fpage>e1005480</fpage>.</mixed-citation></ref>
<ref id="c17"><mixed-citation publication-type="journal"><string-name><surname>Smith</surname>, <given-names>T.</given-names></string-name> <etal>et al.</etal> (<year>2017</year>). <article-title>UMI-tools: modeling sequencing errors in Unique Molecular Identifiers to improve quantification accuracy</article-title>. <source>Genome Res.</source>, <volume>27</volume>(<issue>3</issue>), <fpage>491</fpage>&#x2013;<lpage>499</lpage>.</mixed-citation></ref>
<ref id="c18"><mixed-citation publication-type="journal"><string-name><surname>Stahlberg</surname>, <given-names>A.</given-names></string-name> <etal>et al.</etal> (<year>2016</year>). <article-title>Simple, multiplexed, PCR-based barcoding of DNA enables sensitive mutation detection in liquid biopsies using sequencing</article-title>. <source>Nucleic Acids Res.</source>, <volume>44</volume>(<issue>11</issue>), <fpage>e105</fpage>.</mixed-citation></ref>
<ref id="c19"><mixed-citation publication-type="journal"><string-name><surname>Stahlberg</surname>, <given-names>A.</given-names></string-name> <etal>et al.</etal> (<year>2017</year>). <article-title>Simple multiplexed PCR-based barcoding of DNA for ultrasensitive mutation detection by next-generation sequencing</article-title>. <source>Nat Protoc</source>, <volume>12</volume>(<issue>4</issue>), <fpage>664</fpage>&#x2013;<lpage>682</lpage>.</mixed-citation></ref>
<ref id="c20"><mixed-citation publication-type="journal"><string-name><surname>Tsai</surname>, <given-names>S. Q.</given-names></string-name> <etal>et al.</etal> (<year>2015</year>). <article-title>GUIDE-seq enables genome-wide profiling of off-target cleavage by CRISPR-Cas nucleases</article-title>. <source>Nat. Biotechnol.</source>, <volume>33</volume>(<issue>2</issue>), <fpage>187</fpage>&#x2013;<lpage>197</lpage>.</mixed-citation></ref>
<ref id="c21"><mixed-citation publication-type="journal"><string-name><surname>Tsai</surname>, <given-names>S. Q.</given-names></string-name> <etal>et al.</etal> (<year>2017</year>). <article-title>CIRCLE-seq: a highly sensitive in vitro screen for genome-wide CRISPR-Cas9 nuclease off-targets</article-title>. <source>Nat. Methods</source>, <volume>14</volume>(<issue>6</issue>), <fpage>607</fpage>&#x2013;<lpage>614</lpage>.</mixed-citation></ref>
<ref id="c22"><mixed-citation publication-type="journal"><string-name><surname>Vander Heiden</surname>, <given-names>J. A.</given-names></string-name> <etal>et al.</etal> (<year>2014</year>). <article-title>pRESTO: a toolkit for processing high-throughput sequencing raw reads of lymphocyte receptor repertoires</article-title>. <source>Bioinformatics</source>, <volume>30</volume>(<issue>13</issue>), <fpage>1930</fpage>&#x2013;<lpage>1932</lpage>.</mixed-citation></ref>
<ref id="c23"><mixed-citation publication-type="journal"><string-name><surname>Xu</surname>, <given-names>C.</given-names></string-name> <etal>et al.</etal> (<year>2017</year>). <article-title>Detecting very low allele fraction variants using targeted DNA sequencing and a novel molecular barcode-aware variant caller</article-title>. <source>BMC Genomics</source>, <volume>18</volume>(<issue>1</issue>), <fpage>5</fpage>.</mixed-citation></ref>
<ref id="c24"><mixed-citation publication-type="journal"><string-name><surname>Xu</surname>, <given-names>H.</given-names></string-name> <etal>et al.</etal> (<year>2012</year>). <article-title>FastUniq: a fast de novo duplicates removal tool for paired short reads</article-title>. <source>PLoS ONE</source>, <volume>7</volume>(<issue>12</issue>), <fpage>e52249</fpage>.</mixed-citation></ref>
</ref-list>
</back>
</article>